# ###################################
# This file is managed by puppet
# PLEASE DON'T MODIFY BY HAND
# ###################################
<VirtualHost *:443>

<% if (@name != 'default') -%>
<%= "    ServerName #{@name}\n" -%>
<% end -%>

<%if @server_aliases.is_a? Array -%>
<% @server_aliases.each do |name| -%>
<%= "    ServerAlias #{name}\n" %><% end -%>
<% elsif @server_aliases != '' -%>
<%= "    ServerAlias #{@server_aliases}\n" -%>
<% end -%>

<% if (@admin_email != '') && @admin_email != false -%>
<%= "    ServerAdmin #{@admin_email}\n" -%>
<% end -%>


    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>
    
    DocumentRoot <%= "#{@document_root}\n" -%>
    <Directory <%= "#{@document_root}" -%>>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        Order allow,deny
        allow from all
    </Directory>
    
    Alias /icons/ "/usr/share/apache2/icons/"
    <Directory "/usr/share/apache2/icons">
        Options Indexes MultiViews
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>
    
    # don't loose time with IP address lookups
    HostnameLookups Off
    
    # needed for named virtual hosts
    UseCanonicalName Off
    
    # configures the footer on server-generated documents
    ServerSignature Off
    
    #####################
    # Error pages
    #####################
<% if (@error_403_uri != '') && @error_403_uri != false -%>
<%= "    ErrorDocument 403 #{@error_403_uri}\n" -%>
<% end -%>
<% if (@error_404_uri != '') && @error_404_uri != false -%>
<%= "    ErrorDocument 404 #{@error_404_uri}\n" -%>
<% end -%>
<% if (@error_500_uri != '') && @error_500_uri != false -%>
<%= "    ErrorDocument 500 #{@error_500_uri}\n" -%>
<% end -%>
<% if (@error_502_uri != '') && @error_502_uri != false -%>
<%= "    ErrorDocument 502 #{@error_502_uri}\n" -%>
<% end -%>
<% if (@error_503_uri != '') && @error_503_uri != false -%>
<%= "    ErrorDocument 503 #{@error_503_uri}\n" -%>
<% end -%>

    #####################
    # Include configuration
    #####################
<%if @includes_ssl.is_a? Array -%>
<% @includes_ssl.each do |name| -%>
<%= "    Include #{name}\n" %><% end -%>
<% elsif @includes_ssl != '' && @includes_ssl != false -%>
<%= "    Include #{@includes_ssl}\n" -%>
<% elsif @includes_ssl == false -%>
<%if @includes.is_a? Array -%>
<% @includes.each do |name| -%>
<%= "    Include #{name}\n" %><% end -%>
<% elsif @includes != '' -%>
<%= "    Include #{@includes}\n" -%>
<% end -%>
<% end -%>
    
    #####################
    # Log configuration
    #####################
    ErrorLog        ${APACHE_LOG_DIR}/<%= scope.lookupvar('name') %>-error-ssl.log
    LogLevel        warn
    CustomLog       ${APACHE_LOG_DIR}/<%= scope.lookupvar('name') %>-access-ssl.log combined
    RewriteLog      ${APACHE_LOG_DIR}/<%= scope.lookupvar('name') %>-rewrite-ssl.log
    RewriteLogLevel 0

    #####################
    # SSL configuration
    #####################
    SSLEngine             on
    SSLCertificateFile    <%= scope.lookupvar('apache2::params::ssl_cert_file') %>
    SSLCertificateKeyFile    <%= scope.lookupvar('apache2::params::ssl_cert_key_file') %>
    SSLCertificateChainFile    <%= scope.lookupvar('apache2::params::ssl_cert_chain_file') %>
    SSLVerifyClient None
    # Requires apache 2.3+
    #SSLUseStapling on
    #SSLStaplingCache “shmcb:logs/stapling_cache(128000)”
    
    # configuration du SSL
    # 40-bit mini
    #SSLCipherSuite HIGH:MEDIUM:LOW:EXPORT:!ADH:!DSS:!SSLv2:!EXPORT56:@STRENGTH:+3DES:+DES
    # 128-bit mini
    SSLCipherSuite HIGH:MEDIUM:!ADH:!DSS:!SSLv2:@STRENGTH:+3DES
    SSLProtocol all -SSLv2    
    <FilesMatch "\.(cgi|shtml|phtml|php)$">
        SSLOptions +StdEnvVars
    </FilesMatch>
    <Directory /usr/lib/cgi-bin>
        SSLOptions +StdEnvVars
    </Directory>
    BrowserMatch "MSIE [2-6]" \
        nokeepalive ssl-unclean-shutdown \
        downgrade-1.0 force-response-1.0
    # MSIE 7 and newer should be able to use keepalive
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
    
</VirtualHost>
